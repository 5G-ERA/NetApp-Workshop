# 5G-ERA Reference NetApp Workshop

Robotic platforms and automation systems require to perform complex tasks from time to time to complete their goals. These complex tasks might be computationally heavy and time-consuming while not running on desired hardware (e.g. GPU). However, such tasks/applications might be deployed on EDGE/CLOUD with the more desired hardware and shared between multiple robots. The workshop exploits the possibilities of running such complex tasks/applications like object detection as NetApp for robotic and automation environments.

The workshop will cover the following topics:

* Introduction to the 5G-ERA Reference NetApp
* Explanation of the NetApp Interface
* Requirements for robotic platforms
* A simple scenario in ROS2 environment
* Single-instance (Standalone) NetApp deployment in Kubernetes
* Distributed NetApp deployment in Kubernetes

Before start of this workshop, please be sure, that you complete all steps from [Prerequisities](Documentation/0_Prerequisites.md).

## Introduction

### Update repository and build ROS2 5G-ERA Reference NetApp
```bash
cd ~/NetApp-Workshop/
git pull
cd NetApp_ros2_src/
colcon build
```

### Update .bashrc
```bash
echo "## Source workshop environment" >> ~/.bashrc
echo "source $(pwd)/install/local_setup.sh" >> ~/.bashrc
echo "## Setup environment variables" >> ~/.bashrc
echo "source $(pwd)/set_environment.sh" >> ~/.bashrc
source ~/.bashrc
```

The commands above assume that NetApp-Workshop repository is in the home directory.

## Basic example
In this example, we will use three parts of `ros2_5g_era_basic_example` package (`ml_service`, `image_publisher`, `results_listener`). 

![ALT: Image placeholder](Images/image-placeholder.jpg "IMAGE_PLACEHOLDER_CAPTION")

First, we start the `ml_service` with DummyDetector worker thread inside. At start, `ml_service` will generate specified number of input data and output results topic. This topics will be further used for another parts (`image_publisher`, `results_listener`).

```bash
# Terminal 1
ros2 run ros2_5g_era_basic_example ml_service

# Terminal 2
ros2 topic list
```

In another terminal, we start the `ResultListener` node, which is originally subscribed to `chatter` topic. We use remap function and change the topic to one of the results topic generated by `ml_service` node.
```bash
# Terminal 3
ros2 run ros2_5g_era_basic_example result_listener --ros-args --remap chatter:=/robot1_results
```

Lastly, we run `ImagePublisher` Node, which reads the video file, converts each video frame to ROS2 `Image` message and adds current `timestamp` and `frame_id` into message's header. Originally, `ImagaPublisher` node is publishing results to his `images` topic.
```bash
# Terminal 4
ros2 run ros2_5g_era_basic_example image_publisher --ros-args --remap images:=/robot1_images
```

## Standalone ML service - Basics

ml_service / Service Call / ImagePublisher / ResultSubscriber

![ALT: Image placeholder](Images/image-placeholder.jpg "IMAGE_PLACEHOLDER_CAPTION")
```bash
# Terminal 1
ros2 run ros2_5g_era_object_detection_standalone_py ml_service


# Terminal 2 - Service call
ros2 service call /control_service/start ros2_5g_era_service_interfaces/Start 

ros2 service call /control_service/stop ros2_5g_era_service_interfaces/Stop 'task_id: "{id}"'

# Termial 3
ros2 run ros2_5g_era_basic_example result_listener --ros-args --remap chatter:=/tasks/{id}/results
# or
ros2 topic echo /tasks/{id}/results

# Terminal 4
ros2 run ros2_5g_era_basic_example image_publisher --ros-args --remap images:=/tasks/{id}/data

```

<!-- 
## Demo - Robot / ML_service (Host system) - BACKUP
```bash
# Terminal 1
ros2 run ros2_5g_era_object_detection_standalone_py ml_service

# Terminal 2
ros2 run ros2_5g_era_robot_py robot_node

# Terminal 3
## Start 
ros2 service call robot_logic/start_service ros2_5g_era_robot_interfaces/srv/StartService "{service_base_name: /control_service}"

## Stop
ros2 service call robot_logic/stop_service ros2_5g_era_robot_interfaces/srv/StopService
```
-->


## Standalone ML service in Kubernetes

Modules: Robot / ML_service

TODO: Robot introduction



[Kubernetes Deploy instructions](../NetApp_k8_deploy/README.md)

![ALT: Image placeholder](Images/image-placeholder.jpg "IMAGE_PLACEHOLDER_CAPTION")

```bash
# Terminal 1
cd ~/NetApp-Workshop/NetApp_k8_deploy/ #TODO: Change to NetApp_k8s_deploy ??

kubectl apply -f multus_config.yaml

kubectl apply -f 5gera_ml_service_standalone.yaml

watch "microk8s.kubectl get all"
```

```bash
# Terminal 2
watch "ros2 topic list"
```

After 
```bash
# Terminal 3
ros2 run ros2_5g_era_robot_py robot_node

# Terminal 4
## Start 
ros2 service call robot_logic/start_service ros2_5g_era_robot_interfaces/srv/StartService "{service_base_name: /control_service}"

## Stop
ros2 service call robot_logic/stop_service ros2_5g_era_robot_interfaces/srv/StopService
```

Delete deployed CSS

```bash
kubectl delete deployment.apps/ros-css-deployment
```

## Distributed ML service in Kubernetes

Modules: Robot / ML_service - distributed (Kubernetes)

![ALT: Image placeholder](Images/image-placeholder.jpg "IMAGE_PLACEHOLDER_CAPTION")

```bash
# Terminal 1
cd ~/NetApp-Workshop/NetApp_k8_deploy/ #TODO: Change to NetApp_k8s_deploy ??


kubectl apply -f 5gera_ml_service_distributed.yaml

watch "microk8s.kubectl get all"
```

### OUTPUT

```bash
NAME                                              READY   STATUS    RESTARTS      AGE
pod/rabbit-deployment-644754765-m9s8j             1/1     Running   3 (61s ago)   19h
pod/ml-worker-deployment-6f89c9cbdc-n7v88         1/1     Running   3 (61s ago)   19h
pod/redis-deployment-6d94d9bb58-57ksg             1/1     Running   3 (61s ago)   19h
pod/distributed-css-deployment-7bb85d59bd-9vj4l   1/1     Running   3 (61s ago)   19h

NAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/kubernetes         ClusterIP   10.152.183.1     <none>        443/TCP    46d
service/rabbitmq-service   ClusterIP   10.152.183.213   <none>        5672/TCP   19h
service/redis-service      ClusterIP   10.152.183.158   <none>        6379/TCP   19h

NAME                                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/rabbit-deployment            1/1     1            1           19h
deployment.apps/ml-worker-deployment         1/1     1            1           19h
deployment.apps/redis-deployment             1/1     1            1           19h
deployment.apps/distributed-css-deployment   1/1     1            1           19h

NAME                                                    DESIRED   CURRENT   READY   AGE
replicaset.apps/rabbit-deployment-644754765             1         1         1       19h
replicaset.apps/ml-worker-deployment-6f89c9cbdc         1         1         1       19h
replicaset.apps/redis-deployment-6d94d9bb58             1         1         1       19h
replicaset.apps/distributed-css-deployment-7bb85d59bd   1         1         1       19h
```

```bash
# Terminal 2
watch "ros2 topic list"
```

When all Kubernetes nodes are ready
```bash
# Terminal 3
ros2 run ros2_5g_era_robot_py robot_node

# Terminal 4
## Start 
ros2 service call robot_logic/start_service ros2_5g_era_robot_interfaces/srv/StartService "{service_base_name: /control_service}"

## Stop
ros2 service call robot_logic/stop_service ros2_5g_era_robot_interfaces/srv/StopService
```

Delete all deployments and services

```bash
kubectl delete deployment.apps/ml-worker-deployment
kubectl delete deployment.apps/distributed-css-deployment
kubectl delete deployment.apps/redis-deployment
kubectl delete deployment.apps/rabbit-deployment
kubectl delete service/rabbitmq-service
kubectl delete service/redis-service
```
